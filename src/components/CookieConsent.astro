---
// Cookie Consent Component using Vanilla Cookie Consent
// This component initializes the cookie consent banner with GDPR-compliant settings

// Get GA tracking ID from environment variable
const gaTrackingId = import.meta.env.PUBLIC_GA_TRACKING_ID || '';
---

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanilla-cookieconsent@3/dist/cookieconsent.css" />
<script type="module" define:vars={{ gaTrackingId }}>
  import * as CookieConsent from 'vanilla-cookieconsent';
  
  // Function to load Google Analytics
  function loadGoogleAnalytics(trackingId) {
    // Check if GA is already loaded
    if (window.gtag) {
      // Update consent mode
      window.gtag('consent', 'update', {
        'analytics_storage': 'granted'
      });
      return;
    }

    // Initialize Google Consent Mode v2
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('consent', 'default', {
      'analytics_storage': 'denied'
    });
    
    // Update consent mode when user accepts
    gtag('consent', 'update', {
      'analytics_storage': 'granted'
    });

    // Load Google Analytics script
    const script = document.createElement('script');
    script.async = true;
    script.src = `https://www.googletagmanager.com/gtag/js?id=${trackingId}`;
    document.head.appendChild(script);

    // Initialize GA
    gtag('config', trackingId, {
      anonymize_ip: true,
      cookie_flags: 'SameSite=None;Secure'
    });

    window.gtag = gtag;
  }

  // Function to remove Google Analytics
  function removeGoogleAnalytics() {
    // Remove GA script
    const gaScript = document.querySelector('script[src*="googletagmanager.com/gtag/js"]');
    if (gaScript) {
      gaScript.remove();
    }

    // Clear GA cookies
    const cookies = document.cookie.split(';');
    cookies.forEach(cookie => {
      const eqPos = cookie.indexOf('=');
      const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
      if (name.startsWith('_ga')) {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=.${window.location.hostname}`;
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
      }
    });

    // Clear dataLayer
    if (window.dataLayer) {
      window.dataLayer = [];
    }
    
    delete window.gtag;
  }

  // Initialize cookie consent
  CookieConsent.run({
    categories: {
      necessary: {
        enabled: true, // Always enabled
        readOnly: true // User cannot disable
      },
      analytics: {
        enabled: false, // Requires user consent
        readOnly: false
      }
    },
    language: {
      default: 'en',
      translations: {
        en: {
          consentModal: {
            title: 'We use cookies',
            description: 'We use cookies to enhance your browsing experience, analyze site traffic, and personalize content. By clicking "Accept all", you consent to our use of cookies. <a href="/imprint#privacy" class="cc-link">Privacy Policy</a>',
            acceptAllBtn: 'Accept all',
            acceptNecessaryBtn: 'Reject all',
            showPreferencesBtn: 'Manage preferences'
          },
          preferencesModal: {
            title: 'Cookie Preferences',
            acceptAllBtn: 'Accept all',
            acceptNecessaryBtn: 'Reject all',
            savePreferencesBtn: 'Save preferences',
            closeIconLabel: 'Close',
            sections: [
              {
                title: 'Cookie Usage',
                description: 'We use cookies to ensure the basic functionalities of the website and to enhance your online experience. You can choose for each category to opt-in/out whenever you want.'
              },
              {
                title: 'Strictly Necessary Cookies',
                description: 'These cookies are essential for the proper functioning of the website. Without these cookies, the website would not work properly.',
                linkedCategory: 'necessary'
              },
              {
                title: 'Analytics Cookies',
                description: 'These cookies help us understand how visitors interact with our website by collecting and reporting information anonymously. This helps us improve our website.',
                linkedCategory: 'analytics',
                cookieTable: {
                  caption: 'Analytics cookies',
                  headers: {
                    name: 'Cookie',
                    domain: 'Domain',
                    desc: 'Description',
                    exp: 'Expiration'
                  },
                  body: [
                    {
                      name: '_ga',
                      domain: 'gaworski.de',
                      desc: 'Used to distinguish users by Google Analytics',
                      exp: '2 years'
                    },
                    {
                      name: '_ga_*',
                      domain: 'gaworski.de',
                      desc: 'Used to distinguish users by Google Analytics 4',
                      exp: '2 years'
                    }
                  ]
                }
              }
            ]
          }
        },
        de: {
          consentModal: {
            title: 'Wir verwenden Cookies',
            description: 'Wir verwenden Cookies, um Ihr Browsing-Erlebnis zu verbessern, den Website-Traffic zu analysieren und Inhalte zu personalisieren. Durch Klicken auf "Alle akzeptieren" stimmen Sie der Verwendung von Cookies zu. <a href="/imprint#privacy" class="cc-link">Datenschutzerklärung</a>',
            acceptAllBtn: 'Alle akzeptieren',
            acceptNecessaryBtn: 'Alle ablehnen',
            showPreferencesBtn: 'Einstellungen verwalten'
          },
          preferencesModal: {
            title: 'Cookie-Einstellungen',
            acceptAllBtn: 'Alle akzeptieren',
            acceptNecessaryBtn: 'Alle ablehnen',
            savePreferencesBtn: 'Einstellungen speichern',
            closeIconLabel: 'Schließen',
            sections: [
              {
                title: 'Cookie-Verwendung',
                description: 'Wir verwenden Cookies, um die grundlegenden Funktionen der Website sicherzustellen und Ihr Online-Erlebnis zu verbessern. Sie können für jede Kategorie jederzeit wählen, ob Sie zustimmen möchten oder nicht.'
              },
              {
                title: 'Unbedingt erforderliche Cookies',
                description: 'Diese Cookies sind für das ordnungsgemäße Funktionieren der Website unerlässlich. Ohne diese Cookies würde die Website nicht ordnungsgemäß funktionieren.',
                linkedCategory: 'necessary'
              },
              {
                title: 'Analyse-Cookies',
                description: 'Diese Cookies helfen uns zu verstehen, wie Besucher mit unserer Website interagieren, indem sie Informationen anonym sammeln und melden. Dies hilft uns, unsere Website zu verbessern.',
                linkedCategory: 'analytics',
                cookieTable: {
                  caption: 'Analyse-Cookies',
                  headers: {
                    name: 'Cookie',
                    domain: 'Domain',
                    desc: 'Beschreibung',
                    exp: 'Ablauf'
                  },
                  body: [
                    {
                      name: '_ga',
                      domain: 'gaworski.de',
                      desc: 'Wird verwendet, um Benutzer durch Google Analytics zu unterscheiden',
                      exp: '2 Jahre'
                    },
                    {
                      name: '_ga_*',
                      domain: 'gaworski.de',
                      desc: 'Wird verwendet, um Benutzer durch Google Analytics 4 zu unterscheiden',
                      exp: '2 Jahre'
                    }
                  ]
                }
              }
            ]
          }
        }
      }
    },
    guiOptions: {
      consentModal: {
        layout: 'box inline',
        position: 'bottom right',
        equalWeightButtons: true,
        flipButtons: false
      },
      preferencesModal: {
        layout: 'box',
        position: 'right',
        equalWeightButtons: true,
        flipButtons: false
      }
    },
    onConsent: ({ cookie }) => {
      // This callback is triggered when consent is given or changed
      const analyticsConsent = CookieConsent.acceptedCategory('analytics');
      
      if (analyticsConsent && gaTrackingId) {
        // Load Google Analytics only if consent is given
        loadGoogleAnalytics(gaTrackingId);
      } else {
        // Remove GA if consent is withdrawn
        removeGoogleAnalytics();
      }
    },
    onFirstConsent: ({ cookie }) => {
      // This callback is triggered on first consent
      const analyticsConsent = CookieConsent.acceptedCategory('analytics');
      
      if (analyticsConsent && gaTrackingId) {
        loadGoogleAnalytics(gaTrackingId);
      }
    }
  });

  // Check if consent was already given on page load
  document.addEventListener('DOMContentLoaded', () => {
    const analyticsConsent = CookieConsent.acceptedCategory('analytics');
    if (analyticsConsent && gaTrackingId) {
      loadGoogleAnalytics(gaTrackingId);
    }
  });
</script>
