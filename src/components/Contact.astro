---
import { Cookie } from '@lucide/astro';
---

<section id="contact" class="py-20 bg-gray-900">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-10">
      <!-- Applying font-headline -->
      <h2 class="text-3xl md:text-4xl font-extrabold text-white mb-4 font-headline">Ready to Stop the Bleeding?</h2>
      <p class="text-xl text-gray-300">
        If your project is stalled, your team is blocked, or your time-to-market is too slow, let's schedule a 15-minute diagnostic call.
      </p>
    </div>
    
    <!-- Cal inline embed code - loaded conditionally based on cookie consent -->
    <div class="calcom-embed-wrapper bg-white rounded-lg shadow-xl overflow-hidden">
      <div style="width:100%;height:100%;" id="my-cal-inline-15min">
        <div class="calcom-consent-placeholder" style="padding: 3rem; text-align: center; color: #666; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 600px; width: 100%;">
          <div class="cookie-icon-wrapper" style="margin-bottom: 1.5rem;">
            <Cookie size={64} color="#666" stroke-width={1.5} />
          </div>
          <p style="margin-bottom: 1.5rem; font-size: 1.1rem; margin: 0 0 1.5rem 0;">To book an appointment, please accept functionality cookies in the cookie consent banner.</p>
          <button id="calcom-cookie-preferences-btn" class="cookie-preferences-btn">Manage Cookie Preferences</button>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  function hidePlaceholder() {
    const placeholder = document.querySelector('.calcom-consent-placeholder');
    if (placeholder) {
      (placeholder as HTMLElement).style.display = 'none';
    }
  }

  function showPlaceholder() {
    const placeholder = document.querySelector('.calcom-consent-placeholder');
    if (placeholder) {
      (placeholder as HTMLElement).style.display = 'flex';
    }
  }

  // Listen for Cal.com loaded event from cookie-consent.ts
  window.addEventListener('calcom-loaded', hidePlaceholder);
  
  // Listen for Cal.com removed event
  window.addEventListener('calcom-removed', showPlaceholder);
  
  // Check on page load if Cal.com is already loaded
  document.addEventListener('DOMContentLoaded', () => {
    // Check if Cal.com script exists and is loaded
    const calScript = document.querySelector('script[src*="app.cal.eu/embed/embed.js"]');
    const hasCalLoaded = (window as any).Cal && (window as any).Cal.loaded;
    
    if (hasCalLoaded || calScript) {
      // Cal.com is loaded, hide placeholder
      hidePlaceholder();
    } else {
      // Cal.com is not loaded, show placeholder
      showPlaceholder();
    }

    // Cookie preferences button in placeholder
    const calcomCookieBtn = document.getElementById('calcom-cookie-preferences-btn');
    if (calcomCookieBtn) {
      calcomCookieBtn.addEventListener('click', () => {
        if ((window as any).openCookiePreferences) {
          (window as any).openCookiePreferences();
        }
      });
    }
  });
</script>

<style>
  .calcom-embed-wrapper {
    position: relative;
    width: 100%;
    min-height: 600px;
  }
  
  #my-cal-inline-15min {
    min-height: 600px;
    position: relative;
  }
  
  .calcom-consent-placeholder {
    min-height: 600px;
  }
  
  .cookie-preferences-btn {
    background: #0F2C67;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
    font-family: inherit;
  }
  
  .cookie-preferences-btn:hover {
    background: #00C4CC;
  }
  
  /* Responsive adjustments for mobile */
  @media (max-width: 640px) {
    .calcom-embed-wrapper {
      min-height: 700px;
    }
    
    #my-cal-inline-15min {
      min-height: 700px;
    }
  }
</style>

